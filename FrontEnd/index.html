<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Warehouse Management System</title>
  <link rel="stylesheet" href="./style.css" />

  <!-- Day.js for timestamp formatting -->
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/relativeTime.js"></script>
  <script>
    dayjs.extend(window.dayjs_plugin_relativeTime);
  </script>
</head>

<body>
  <!-- Header -->
  <header class="app-header">
    <h1>Warehouse Management System</h1>
    <div class="user-bar">
      <span id="roleBadge"></span>
      <button id="logoutBtn" hidden>Logout</button>
    </div>
  </header>

  <!-- Login Section -->
  <section id="loginSection">
    <form id="loginForm" class="auth-form">
      <h2>Sign In</h2>
      <input id="loginEmail" type="email" placeholder="Email" required />
      <input id="loginPassword" type="password" placeholder="Password" required />
      <button type="submit">Login</button>
    </form>
  </section>

  <!-- Main App Section -->
  <section id="appSection" hidden>
    <!-- Toolbar -->
    <div class="toolbar">
      <input id="q" type="search" placeholder="Search items..." />
      <select id="status">
        <option value="">All</option>
        <option value="available">Available</option>
        <option value="checked_out">Checked Out</option>
      </select>
      <select id="system"></select>
      <select id="shelf"></select>
      <input id="holder" type="text" placeholder="Holder" />
      <label><input id="include_deleted" type="checkbox" /> Show deleted</label>
      <select id="page_size">
        <option>50</option><option>100</option><option>200</option>
      </select>
      <button id="refreshBtn" type="button">Refresh</button>
    </div>

    <!-- Items Table -->
    <div class="table-scroll-region">
      <table id="itemsTable" class="file-table">
        <thead class="file-table-head">
          <tr>
            <th data-sort="name">Name</th>
            <th data-sort="sku">SKU</th>
            <th data-sort="system_code">System</th>
            <th data-sort="shelf_label">Shelf</th>
            <th data-sort="quantity_on_hand">Qty</th>
            <th data-sort="last_movement_ts">Last Activity</th>
            <th data-sort="clearance_level">CL</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="itemsTbody"></tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div class="pager">
      <button id="prevPage">&larr; Prev</button>
      <span id="pagerStatus"></span>
      <button id="nextPage">Next &rarr;</button>
    </div>
  </section>

  <!-- Item Drawer -->
  <dialog id="itemDrawer">
    <div id="itemDetail"></div>
    <div class="drawer-actions">
      <button id="itemDeleteBtn" data-requires-role="admin">Delete</button>
      <button id="itemRestoreBtn" data-requires-role="admin">Restore</button>
      <button id="openMovementModal">Record Movement</button>
      <button id="closeItemDrawer" type="button">Close</button>
    </div>
  </dialog>

  <!-- Movement Modal -->
  <dialog id="movementModal">
    <nav class="tabs">
      <button data-kind="receive">Receive</button>
      <button data-kind="issue">Issue</button>
      <button data-kind="return">Return</button>
      <button data-kind="adjust" data-requires-role="admin">Adjust</button>
      <button data-kind="transfer">Transfer</button>
    </nav>

    <div class="modal-body">
      <form id="mvReceive" data-kind="receive" hidden>
        <h3>Receive</h3>
        <input name="item_id" placeholder="Item ID" required />
        <input name="shelf_id" placeholder="Shelf ID" required />
        <input name="qty" type="number" placeholder="Quantity" required />
        <input name="note" placeholder="Note" />
        <button type="submit">Submit</button>
      </form>

      <form id="mvIssue" data-kind="issue" hidden>
        <h3>Issue</h3>
        <input name="item_id" placeholder="Item ID" required />
        <input name="shelf_id" placeholder="Shelf ID" required />
        <input name="qty" type="number" placeholder="Quantity" required />
        <input name="holder" placeholder="Holder" required />
        <input name="due_at" type="datetime-local" />
        <input name="note" placeholder="Note" />
        <button type="submit">Submit</button>
      </form>

      <form id="mvReturn" data-kind="return" hidden>
        <h3>Return</h3>
        <input name="item_id" placeholder="Item ID" required />
        <input name="shelf_id" placeholder="Shelf ID" required />
        <input name="qty" type="number" placeholder="Quantity" required />
        <input name="holder" placeholder="Holder" />
        <input name="note" placeholder="Note" />
        <button type="submit">Submit</button>
      </form>

      <form id="mvAdjust" data-kind="adjust" hidden>
        <h3>Adjust (Admin)</h3>
        <input name="item_id" placeholder="Item ID" required />
        <input name="shelf_id" placeholder="Shelf ID" required />
        <input name="qty_delta" type="number" placeholder="Delta Quantity" required />
        <input name="note" placeholder="Reason" required />
        <button type="submit">Submit</button>
      </form>

      <form id="mvTransfer" data-kind="transfer" hidden>
        <h3>Transfer</h3>
        <input name="item_id" placeholder="Item ID" required />
        <input name="from_shelf_id" placeholder="From Shelf ID" required />
        <input name="to_shelf_id" placeholder="To Shelf ID" required />
        <input name="qty" type="number" placeholder="Quantity" required />
        <input name="note" placeholder="Note" />
        <button type="submit">Submit</button>
      </form>
    </div>

    <button id="closeMovementModal" type="button">Close</button>
  </dialog>

  <!-- Admin Section -->
  <section id="adminSection" hidden>
    <h2>Admin Dashboard</h2>

    <div class="admin-block">
      <h3>Systems</h3>
      <form id="systemForm" data-requires-role="admin">
        <input name="id" type="hidden" />
        <input name="code" placeholder="Code" required />
        <input name="notes" placeholder="Notes" />
        <button type="submit">Save</button>
      </form>
      <table><tbody id="systemsTable"></tbody></table>
    </div>

    <div class="admin-block">
      <h3>Shelves</h3>
      <form id="shelfForm" data-requires-role="admin">
        <input name="id" type="hidden" />
        <input name="system_id" placeholder="System ID" required />
        <input name="label" placeholder="Label" required />
        <input name="length_mm" placeholder="Length (mm)" required />
        <input name="width_mm" placeholder="Width (mm)" required />
        <input name="height_mm" placeholder="Height (mm)" required />
        <input name="ordinal" type="number" placeholder="Ordinal" />
        <button type="submit">Save</button>
      </form>
      <table><tbody id="shelvesTable"></tbody></table>
    </div>

    <div class="admin-block">
      <h3>Users</h3>
      <form id="userForm" data-requires-role="admin">
        <input name="email" type="email" placeholder="Email" required />
        <input name="name" placeholder="Name" required />
        <select name="role" required>
          <option value="user">User</option>
          <option value="admin">Admin</option>
        </select>
        <input name="password" type="password" placeholder="Password" required />
        <input name="max_clearance_level" type="number" placeholder="Max CL (optional)" />
        <button type="submit">Add User</button>
      </form>
      <table><tbody id="usersTable"></tbody></table>
    </div>
  </section>

  <!-- Scripts -->
  <script defer type="module" src="./app.js"></script>
  <script defer type="module" src="./admin.js"></script>
</body>
</html>
